// Uses Declarative syntax to run commands inside a container.
pipeline {
   environment {
      monitoringNS = "monitoring"
   
      rabbitMqServerURL = "rabbitMQ"
      rabbitMqServerPort = "5672"

      rabbitMqProducerMessage = "Hello"
      rabbitMqProducerTimesToRepeat = "30"
      
      gitProjectName = "k8s-project"
      gitProjectURL = "https://github.com/ohadm2/k8s-project.git"
   }
    agent {
        kubernetes {
            // Rather than inline YAML, in a multibranch Pipeline you could use: yamlFile 'jenkins-pod.yaml'
            // Or, to avoid YAML:
            // containerTemplate {
            //     name 'shell'
            //     image 'ubuntu'
            //     command 'sleep'
            //     args 'infinity'
            // }
            yaml '''
apiVersion: v1
kind: Pod
spec:
  containers:
  - name: helm-kubectl
    image: dtzar/helm-kubectl
    command:
    - cat
    tty: true
    volumeMounts:
    - mountPath: /var/run/docker.sock
      name: docker-sock
  volumes:
    - name: docker-sock
      hostPath:
        path: /var/run/docker.sock
'''
            // Can also wrap individual steps:
            // container('shell') {
            //     sh 'hostname'
            // }
            defaultContainer 'helm-kubectl'
        }
    }
    stages {
        stage('general') {
          steps {
            apk update
          }
        }
        stage('get-helm-charts') {
            steps {
                sh ''' 
                    apk add git
                    git clone ${gitProjectURL}
                    
                    cd ${gitProjectName}
                '''
            }
        }
        stage('deploy helm charts') {
            steps {
                withKubeConfig([credentialsId: 'minikube-crt', serverUrl: 'https://192.168.49.2:8443', clusterName: 'minikube']) {
                
                  sh ''' 
                  
                  apk add curl
               
                  curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
                  
                  chmod u+x ./kubectl
                  
                  # for testing access
                  ./kubectl get ns
                  
                  ./kubectl create ns ${monitoringNS} || true
                  
                  helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
                  helm repo add kube-state-metrics https://kubernetes.github.io/kube-state-metrics
                  helm upgrade -i prometheus prometheus-community/prometheus --namespace monitoring -f prometheus/values.yml
                  
                  helm repo add bitnami https://charts.bitnami.com/bitnami 
                  
                  helm upgrade -i my-rabbit bitnami/rabbitmq --set ingress.enabled=true,ingress.hostname=${rabbitMqServerURL},service.port=${rabbitMqServerPort},metrics.enabled=true
                  
                  helm upgrade -i my-producer ./producer-helm-chart --set port=${rabbitMqServerPort},server=${rabbitMqServerURL},message=${rabbitMqProducerMessage},repeat=${rabbitMqProducerTimesToRepeat}
                  
                  helm upgrade -i my-consumer ./consumer-helm-chart --set port=${rabbitMqServerPort},server=${rabbitMqServerURL}
                  
                  
                  '''
                
                }
            }
        }
    }
}    
